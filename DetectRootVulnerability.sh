#!/bin/bash
buildver=$(/usr/bin/sw_vers -buildVersion)
major=${buildver:0:3}
minor=${buildver:3}

if [[ "$(/usr/bin/sw_vers -productVersion)" != "10.13"* ]]; then
	# Not High Sierra, so not affected
	echo "<result>Not affected</result>"
	exit 0
fi
if [[ "$major" > "17B" ]] || ( [[ "$major" = "17B" ]] && [ "$minor" -ge 1002 ] ); then
	# Already patched by Apple
	echo "<result>Patched</result>"
	exit 0
fi
if [ "$(dscl . -read /Users/root passwd | awk '{print $2}')" = '*' ]; then 
	# Vulnerable, not yet exploited
	echo "<result>Vulnerable</result>"
else
	result=$(sudo -u 'nobody' /usr/bin/osascript -e 'do shell script "/bin/echo Exploited" user name "root" password "" with administrator privileges' 2>/dev/null)
	if [ "$result" = 'Exploited' ]; then
		# Vulnerable and already exploited 
		echo "<result>Exploited</result>"
	else
		# On vulnerable OS, but already been secured through other means
		echo "<result>Secure</result>"
	fi
fi